<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Media Sphere</title>

    <!-- FFMpeg -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.1/dist/ffmpeg.min.js"></script> -->

    <!-- Include Google Cast SDK -->
    <!-- <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script> -->
    <!-- <script type="text/javascript" src="https://www.gstatic.com/cast/sdk/libs/sender/1.0/cast_framework.js"></script> -->
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script type="text/javascript">
        // Initialize the Cast API when the Cast SDK is available
        window['__onGCastApiAvailable'] = function(isAvailable) {
            console.log("Google Cast API is available: " + isAvailable);

            if (isAvailable) {
                initializeCastApi();
            } else {
                console.error("Google Cast API is not available.");
            }
        };

        var casting = false;

        // Initialize the Cast API only when the SDK is available
        function initializeCastApi() {
            if (window.cast && window.cast.framework) {
                try {
                    const castContext = cast.framework.CastContext.getInstance();
                    castContext.setOptions({
                        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID, // Default receiver ID
                        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED, // Auto join policy
                    });
                    console.log("Google Cast initialized.");

                    casting = true;

                } catch (error) {
                    console.error("Error initializing Google Cast:", error);
                }
            } else {
                console.error("cast.framework is not defined.");
            }
        }

        function stopCasting() {
          event.stopPropagation();

          var castSession = cast.framework.CastContext.getInstance().getCurrentSession();
          // End the session and pass 'true' to indicate
          // that Web Receiver app should be stopped.
          castSession.endSession(true);
        }

        function initCastPlayer() {
          showVideoControls();

          playPauseButton.classList.remove('playing');
          playPauseButton.classList.remove('repeat');
          playPauseButton.classList.add('cast_connected');

          video.src = "";
          audio.src = "";

          // videoLoadProgressBar.style.transform = `scaleX(1)`;
          // videoProgressBar.style.transform = `scaleX(1)`;

          // videoCurrentTime.textContent = "casting";

          videoLoadProgressBar.style.opacity = 0;

          loading = false;

          loadingRing.style.display = "none";
          playPauseButton.style.display = "block";

          autoResToggle();
          videoInfoElm.autoResLive.innerHTML = videoDetails.formats["0"].qualityLabel;
          // add .disabled to all .resBtn
          // Select all elements with the class 'resBtn'
          const btnElements = document.querySelectorAll('#infoContainer .otherResBtn');

          // Add another class to each element
          btnElements.forEach(element => {
            element.classList.add('disabled'); // Replace 'newClass' with the class you want to add
          });
        }

        var castCurrentTime = 0;

        function stopCastPlayer() {
          // if (casted) {
            playPauseButton.classList.remove('cast_connected');

            videoLoadProgressBar.style.opacity = 1;

            if (timeToSeconds(videoCurrentTime.textContent)) {
              castCurrentTime = timeToSeconds(videoCurrentTime.textContent);
            }

            video.src = localStorage.getItem("videoURL");
            audio.src = localStorage.getItem("audioURL");
          // }

          videoInfoElm.autoResLive.innerHTML = qualityLabel(targetVideo.qualityLabel);

          const btnElements = document.querySelectorAll('#infoContainer .otherResBtn');

          // Add another class to each element
          btnElements.forEach(element => {
            element.classList.remove('disabled'); // Replace 'newClass' with the class you want to add
          });
            
            casting = false;
        }

        var player;
        var playerController;

        function addPlayerControl() {
          player = new cast.framework.RemotePlayer();
          playerController = new cast.framework.RemotePlayerController(player);

          // Play/Pause Button for controlling the receiver
          playPauseButton.addEventListener('click', () => {
              console.log('Play/Pause button clicked.');
              playerController.playOrPause(); // Toggles play/pause state on the receiver

              if (!player.isMediaLoaded) {
                castVideoWithAudio(videoDetails.formats["0"].url, true);
              }
          });

          // Handle Media Info Changes
          playerController.addEventListener(
              cast.framework.RemotePlayerEventType.MEDIA_INFO_CHANGED,
              () => {
                  console.log('Media info changed.');
                  let session = cast.framework.CastContext.getInstance().getCurrentSession();

                  if (!session) {
                      console.warn('No active session.');
                      return;
                  }

                  let mediaStatus = session.getMediaSession();
                  if (!mediaStatus) {
                      console.warn('No media status available.');
                      return;
                  }

                  let mediaInfo = mediaStatus.media;
                  console.log('Updated media info:', mediaInfo);
              }
          );

          playerController.addEventListener(
              cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED,
              () => {
                  // console.log(`Current time: ${player.currentTime}`);
                  // You can perform actions based on the updated time here

                  if (player.currentTime || timeToSeconds(videoCurrentTime.textContent)) {
                    refSeekTime = player.currentTime ? player.currentTime : timeToSeconds(videoCurrentTime.textContent);
                    localStorage.setItem('timestamp', refSeekTime); // SET timestamp memory
                  }

                  // updatePositionState();
                  videoCurrentTime.textContent = secondsToTimeCode(player.currentTime);
                  videoProgressPercentile = (player.currentTime / player.duration);
                  videoProgressBar.style.transform = `scaleX(${player.currentTime / player.duration})`;

                  loadingRing.style.display = "none";
                  playPauseButton.style.display = "block";

                   // Add loop functionality: Check if the video is close to the end
                  if ((player.currentTime >= player.duration - 0.1) && player.duration && videoLoop) { // Tolerance of 0.1 seconds
                      console.log("Video ended, restarting...");
                      // player.currentTime = 0; // Reset the video to the beginning
                      // playerController.seek(); // Trigger seek to restart playback

                      castVideoWithAudio(videoDetails.formats["0"].url, true);
                  }
              }
          );

          // Handle Connection State Changes
          playerController.addEventListener(
              cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED,
              () => {
                  if (!player.isConnected) {
                      console.log('Receiver disconnected.');
                      // Perform any necessary cleanup or UI updates for disconnection

                      stopCastPlayer();

                      casted = false;

                      videoInfoElm.cast.classList.remove("active");
                      videoInfoElm.gCast.classList.remove("disabled");
                      videoInfoElm.cast.setAttribute("onclick", "castVideoWithAudio('" + videoDetails.formats["0"].url + "')");

                  } else {
                      console.log('Receiver connected.');
                      // Perform any necessary setup for connection

                      addPlayerControl();

                      initCastPlayer();

                      videoInfoElm.cast.classList.add("active");
                      videoInfoElm.gCast.classList.add("disabled");
                      videoInfoElm.cast.setAttribute("onclick", "stopCasting()");

                      if (!casted) {
                        casted = true;
                        castVideoWithAudio(videoDetails.formats["0"].url);
                      }
                  }
              }
          );
        
          // Listen for changes in the paused state of the receiver
          playerController.addEventListener(
              cast.framework.RemotePlayerEventType.IS_PAUSED_CHANGED,
              () => {
                  if (player.isPaused) {
                      console.log('The receiver is now paused.');
                      // Take appropriate actions when the receiver pauses
                  } else {
                      console.log('The receiver is now playing.');
                      // Take appropriate actions when the receiver resumes
                      addPlayerControl();
                  }
              }
          );
        }

 
        var casted = false;

        // Cast the video and audio to a Chromecast device
        function castVideoWithAudio(videoUrl, reset) {
          /*
            if (!isCastAvailable) {
                console.error("Google Cast API is not available. Cannot cast video and audio.");
                return;
            }*/

            const castContext = cast.framework.CastContext.getInstance();
            const session = castContext.getCurrentSession();

            // Listen for session state changes
            castContext.addEventListener(
              cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
              function(event) {
                switch (event.sessionState) {
                  case cast.framework.SessionState.SESSION_STARTED:
                    console.log('Casting session started');

                    addPlayerControl();

                    initCastPlayer();

                    videoInfoElm.cast.classList.add("active");
                    videoInfoElm.gCast.classList.add("disabled");
                    videoInfoElm.cast.setAttribute("onclick", "stopCasting()");

                    if (!casted) {
                      casted = true;
                      castVideoWithAudio(videoDetails.formats["0"].url);
                    }

                    break;
                  case cast.framework.SessionState.SESSION_ENDED:
                    console.log('Casting session ended');
                    // Handle casting stopped

                    stopCastPlayer();

                    casted = false;

                    videoInfoElm.cast.classList.remove("active");
                    videoInfoElm.gCast.classList.remove("disabled");
                    videoInfoElm.cast.setAttribute("onclick", "castVideoWithAudio('" + videoDetails.formats["0"].url + "')");

                    break;
                  case cast.framework.SessionState.SESSION_RESUMED:
                    console.log('Casting session resumed');

                    addPlayerControl();

                    initCastPlayer();

                    videoInfoElm.cast.classList.add("active");
                    videoInfoElm.gCast.classList.add("disabled");
                    videoInfoElm.cast.setAttribute("onclick", "stopCasting()");

                    if (!casted) {
                      casted = true;
                      castVideoWithAudio(videoDetails.formats["0"].url);
                    }

                    break;
                  default:
                    console.log('Other session state:', event.sessionState);
                    break;
                }
              }
            );

            if (session) {
                // Create the media info object for video and audio
                const mediaInfo = new chrome.cast.media.MediaInfo(videoUrl, 'video/mp4');
                mediaInfo.customData = {
                    lastPlaybackPosition: localStorage.getItem('timestamp') || refSeekTime || 0,
                };

                /*
                const audioTrack = new chrome.cast.media.AudioTrack();
                audioTrack.src = audioUrl; // Set the audio URL
                mediaInfo.tracks = [audioTrack]; // Add the audio track to media info*/

                const request = new chrome.cast.media.LoadRequest(mediaInfo);
                /*
                if (videoLoop) {
                  request.media = mediaInfo;
                  request.media.metadata = new chrome.cast.media.GenericMediaMetadata();
                  request.media.repeatMode = chrome.cast.media.RepeatMode.SINGLE; // Loop the video
                }*/

                var a = parseFloat(localStorage.getItem('timestamp') || refSeekTime);
                var c = parseFloat(localStorage.getItem('duration'));
                var b = (a > minVideoLoad && (a < (c - maxVideoLoad)));

                // Set the startTime to the saved position or 0 if none is available
                if (!b || reset) {
                  request.currentTime = 0;
                } else {
                  request.currentTime = parseFloat(localStorage.getItem('timestamp') || refSeekTime) || 0;
                }

                session.loadMedia(request).then(function() {
                    console.log('Video and Audio loaded successfully.');

                    casted = true;

                    console.log('Casting session resumed');

                    addPlayerControl();

                    initCastPlayer();

                    videoInfoElm.cast.classList.add("active");
                    videoInfoElm.gCast.classList.add("disabled");
                    videoInfoElm.cast.setAttribute("onclick", "stopCasting()");

                    /*
                    // Get the media session
                    const media = session.getMediaSession();

                    if (media) {
                        // Listen for the MEDIA_FINISHED event
                        media.addUpdateListener(() => {
                            if (media.playerState === chrome.cast.media.PlayerState.IDLE &&
                                media.idleReason === chrome.cast.media.IdleReason.FINISHED && videoLoop) {
                                console.log('Video finished. Restarting...');
                                session.loadMedia(mediaLoadRequest); // Restart the media
                            }
                        });
                    }*/

                }, function(error) {
                    console.error('Error loading media:', error);
                });
            } else {
                console.error("No active cast session found.");
            }
        }
    </script>
    
    <meta name="theme-color" content="#000">

    <meta charset="utf-8" />
    <meta name="viewport" content="viewport-fit=cover, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, shrink-to-fit=no, interactive-widget=overlays-content" >
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src *; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'; img-src * data: 'unsafe-inline'; connect-src * 'unsafe-inline'; frame-src *;"> -->
    
    <!-- OpenGraph/Social sharing -->
    <meta
      name="description"
      content="An installable Media Sphere app."
    />
    <meta
      name="og:description"
      content="An installable Media Sphere app."
    />
    <meta
      property="og:image"
      content="https://cdn.glitch.global/4604ff4b-6eb8-48c8-899f-321d23359af1/Media%20Player%20OG%20Image.png?v=1721623654736"
    />
    <meta property="og:title" content="Media Sphere" />
    <meta name="twitter:card" content="summary" />
    <!-- 
    <link
      rel="icon"
      href="https://cdn.glitch.global/4604ff4b-6eb8-48c8-899f-321d23359af1/play.svg?v=1720968680771"
    /> -->
    <link
      rel="icon"
      href="https://ivansojivarghese.github.io/media-sphere/play.png"
    />
    
    <link rel="stylesheet" type="text/css" href="https://ivansojivarghese.github.io/media-sphere/css/main.css" />
    <link rel="stylesheet" type="text/css" href="https://ivansojivarghese.github.io/media-sphere/css/new.css" />
    <link rel="stylesheet" type="text/css" href="https://ivansojivarghese.github.io/media-sphere/css/res_m.css" />
    
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins&display=swap');
    </style>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Raleway&display=swap');
    </style>
    
    <!-- <script src="https://cdn.jsdelivr.net/npm/@thelevicole/youtube-to-html5-loader@5/dist/YouTubeToHtml5.js"></script> -->
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- PWA setup - update public/sw.js if you add your own assets like a new .css file -->
    <link rel="manifest" href="https://ivansojivarghese.github.io/media-sphere/manifest.json" />
    
    <script src="https://ivansojivarghese.github.io/media-sphere/index.js" async defer></script>
    
  </head>
  <body>
    <main>
      <div class="content trs">
        <div id="videoContainer" class="trs">
          <video class="primary trs active" preload="auto">
            <audio class="primary" preload="auto"></audio>
            <track src="" kind="subtitles" srclang="" label="" default>
          </video> 
          <video class="secondary trs" preload="auto" disablePictureInPicture></video>
          <div id="videoControls" class="trs">
              <div id="videoInfo" class="trs no-tap cursor" onclick="openVideoInfo()" title="Open Panel">
                <div class="textStuff">
                  <h5></h5>
                  <p></p>
                </div>
                <div class="infoOpener">
                  <div class="img"></div>
                </div>
              </div>
              <div id="loadingRing">
                <!-- <div class="circle"></div> -->
                <div id="load_box" class="loadContainer p-a c-x trs">
                  <div id="loadR" class="loadWrap aniM h_wd h-h trs">
                      <div id="loadR-p" class="load_r load_r_pwa aniM trs"></div>
                      <div id="loadR-m" class="load_r load_r_pwa aniM trs"></div>
                      <div id="loadR-e" class="load_r load_r_pwa aniM-f trs"></div>
                      <div id="loadR-s" class="load_r load_r_pwa aniM trs"></div>
                  </div>
              </div>
              </div>
              <div id="playPauseButton" class="trsButtons trs" title="Play">
                <div class="img trs"></div>
              </div>
              <div id="seekControls">

                <!-- <button id="castButton">Cast</button> -->

                <div id="statusIndicator" class="seekButton" style="display: none;">
                  <div class="trs"></div>
                </div>
                <div id="pipButton" class="seekButton trsButtons trs" title="Picture-in-Picture">
                  <div class="img trs controlButton"></div>
                </div>
                <div id="fitscreenButton" class="seekButton trsButtons trs" title="Fit screen">
                  <div class="img trs controlButton"></div>
                </div>
                <!-- 
                <div id="settingsButton" class="seekButton trsButtons trs" title="">
                  <div class="img trs controlButton"></div>
                </div> -->
                <div id="searchButton" class="seekButton trsButtons trs" title="Search">
                  <div class="img trs controlButton"></div>
                </div>
                <!-- 
                <div id="fullscreenButton" class="seekButton">
                  <div class="img controlButton"></div>
                </div> -->
              </div>
              <div id="seekForwardButton" class="no-tap trsButtons trs" title="Seek forwards">
                <div class="img trs controlButton no-tap"></div>
              </div>
              <div id="seekBackwardButton" class="no-tap trsButtons trs" title="Seek backwards">
                <div class="img trs controlButton no-tap"></div>
              </div>
              <div id="skipPreviousButton" class="no-tap trsButtons trs" title="Previous track">
                <div class="img trs controlButton no-tap"></div>
              </div>
              <p class="seekText forward trs">+<span class="seconds">10</span> sec.</p>
              <p class="seekText backward trs">-<span class="seconds">10</span> sec.</p>
              <div class="timestamps">
                <p id="videoCurrentTime"></p>
                <p class="durationDiv">/</p>
                <p class="duration">00:00</p>
              </div>
              <div id="videoScrub" class="cursor" title="Seek"></div>
              <div id="videoProgressBar" class="cursor bar" title=""></div>
              <div id="videoLoadProgressBar" class="cursor bar" title=""></div>
              <div id="videoBarPlaceholder" class="cursor bar" title=""></div>
          </div>
          <div id="infoContainer" class="trs">
            <div class="loadingSpace">
              <div class="loaderDots"></div>
            </div>
            <div class="head">
              <div class="headSec">
                <div class="homeBtn cursor trs trsButtons noimg" onclick="" title="Home">
                  <div class="img"></div>
                </div>
                <div class="trendingBtn cursor trs trsButtons noimg" onclick="" title="Trending">
                  <div class="img"></div>
                </div>
                <div class="searchBtn cursor trs trsButtons noimg" onclick="openSearch()" title="Search">
                  <div class="img"></div>
                </div>
                <div class="infoBtn cursor trs trsButtons noimg" onclick="openVideoInfo()" title="Info">
                  <div class="img"></div>
                </div>
                <div class="closeBtn cursor trs trsButtons noimg" onclick="closeVideoInfo()" title="Close Panel">
                  <div class="img"></div>
                </div>
              </div>
            </div>
            <div class="wrapper search">
              <div class="searchPath">
                <div class="url otherResBtn resBtn trs active" onclick="setSearchPath(event)">
                  <p>URL</p>
                </div>
                <div class="query otherResBtn resBtn trs" onclick="setSearchPath(event)">
                  <p>QUERY</p>
                </div>
              </div>
              <input class="" type="url" id="urlBar" placeholder="" name="" autocapitalize="off" enterkeyhint="go" inputmode="url">
              <span class="clear-btn cursor" onclick="clearInput(true)" title="Clear input" style="display: none;">Ã—</span>
              <p class="inputError"></p>
              <div class="searchOptions" style="display: none;">
                <div>
                  <p>Type:</p>
                  <select id="searchType">
                    <option value="">---</option>
                    <option value="video">Video</option>
                    <option value="playlist">Playlist</option>
                  </select>
                </div>
                <div>
                  <p>Upload:</p>
                  <select id="searchUpload">
                    <option value="">---</option>
                    <option value="today">Today</option>
                    <option value="hour">Hour</option>
                    <option value="week">Week</option>
                    <option value="month">Month</option>
                    <option value="year">Year</option>
                  </select>
                </div>
                <div>
                  <p>Sort:</p>
                  <select id="searchSort">
                    <option value="">---</option>
                    <option value="relevance">Relevance</option>
                    <option value="rating">Rating</option>
                    <option value="date">Date</option>
                    <option value="views">Views</option>
                  </select>
                </div>
              </div>
              <input id="urlSubmit" class="resBtn trs" type="submit" onclick="getURL()">
              <div class="refinements"></div>
              <div class="results"></div>
            </div>
            <div class="wrapper info">
              <h5 class="videoTitle"></h5>
              <p class="channelTitle"></p>
              <p class="category"></p>
              <div class="criticalInfo">
                <div class="cI">
                  <p class="date"></p>
                  <p class="expires"></p>
                  <!-- <p class="duration"></p> -->
                </div>
                <div class="cI">
                  <p class="likes"></p>
                  <p class="views"></p>
                </div>
              </div>
              <div class="resolutions">
                <div class="autoRes">
                  <div class="videoInfoBtns replay trs trsButtons noimg cursor" onclick="loopVideoToggle()" title="Loop video">
                    <div class="img"></div>
                  </div>
                  <div class="videoInfoBtns radio trs trsButtons noimg cursor" onclick="radioToggle()" title="Radio">
                    <div class="img"></div>
                  </div>
                  <div class="videoInfoBtns cast trs trsButtons noimg cursor" onclick="" title="Cast" style="display: none;">
                    <!-- <div class="img"></div> -->
                    <!-- Cast Button -->
                    <google-cast-launcher></google-cast-launcher>
                  </div>
                  <div class="autoResBtn resBtn trs" onclick="autoResToggle()">
                    <p>AUTO</p>
                  </div>
                  <p class="autoResLive"></p>
                </div>
                <div class="otherRes"></div>
              </div>
              <div class="keywords"></div>
              <div class="description">
                <p></p>
              </div>
              <div class="results"></div>
            </div>
          </div>
        </div>

        <!-- 
        <div class="card trs settings" onclick="openWrap('settings')">
          <div class="img"></div>
        </div> -->

        <!-- 
        <div class="card upload" onclick="document.getElementById('fileSelector').click()">
              <input class="card upload" id="fileSelector" type="file" style="display: none;" multiple accept=".mp4, .webm, .ogg"/>
            <input class="card img upload" type="button">
            </div> -->
      </div>
      <div id="settingsOptions" class="wrap" onclick="closeWrap(event, 'settings')">
        <div class="container">
            <!-- 
            <div class="card fullscreen" onclick="toggleFulls()">
              <div class="img"></div>
            </div>
            <div class="card play" onclick="play()">
              <div class="img"></div>
            </div>
            <div class="card pause" onclick="pause()">
              <div class="img"></div>
            </div> 
            <div class="card load" onclick="load()">
              <div class="img"></div>
            </div> 
            <div class="card install" onclick="" style="opacity: 0.3;">
              <div class="img"></div>
            </div> -->
            
            <div class="card upload" onclick="document.getElementById('fileSelector').click()">
              <input class="card upload" id="fileSelector" type="file" style="display: none;" multiple accept=".mp4, .webm, .ogg"/>
            <input class="card img upload" type="button">
            </div> 
          
            <div class="card web_upload" onclick="openWrap('webupload')">
              <div class="img"></div>
            </div>
          <!-- 
            <div class="card pip" onclick="togglePiP()" style="display: none;">
              <div class="img"></div>
            </div> -->
          <!-- 
            <div class="card pip">
              <div class="img"></div>
            </div>
            <div class="card pip">
              <div class="img"></div>
            </div>
            <div class="card pip">
              <div class="img"></div>
            </div>
            <div class="card pip">
              <div class="img"></div>
            </div> -->
          </div>
        </div>
      <div id="urlInput" class="wrap" onclick="closeWrap(event, 'webupload')">
        <div class="container block">
            <h3>URL Entry</h3>
            <p>for YouTube</p>
            <input class="noExit" type="url" id="" placeholder="https://" name="">
            <input id="" class="" type="submit" onclick="getURL()">
        </div>
      </div>
    </main>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
  <!-- <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script> -->

  <script src="https://ivansojivarghese.github.io/media-sphere/js/dev.js"></script>
  <script src="https://ivansojivarghese.github.io/media-sphere/js/network.js"></script>
  <script src="https://ivansojivarghese.github.io/media-sphere/js/msc.js"></script>
  <!-- <script src="https://ivansojivarghese.github.io/media-sphere/js/scriptSec.js"></script> -->
  <script src="https://ivansojivarghese.github.io/media-sphere/js/script.js"></script>
  <script src="https://ivansojivarghese.github.io/media-sphere/js/request.js"></script>
  <script src="https://ivansojivarghese.github.io/media-sphere/js/video.js"></script>

  <script>
    
    var wrap = document.querySelector("#settingsOptions");
        if (window.FileList && window.File) {
          document.getElementById('fileSelector').addEventListener('change', event => {
              // console.log(event.target.files[0]);
              
              const file = event.target.files[0];
              
              var fileURL = URL.createObjectURL(file)
              video.src = fileURL;
            
              video.play();
            
              // video.classList.remove("error");
            
              // video.style.border = "0.15rem solid #A10000";
            
              wrap.style.display = "";
          });
        }

  </script>
  <script>
    function isDarkMode() { // dark mode detection
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    
    if (isDarkMode()) {
      //document.body.style.color = "#FFF";
      //document.body.style.backgroundColor = "#171717";
    }
    
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',({ matches }) => { // detect color theme (live) change
      if (matches) { // change to dark mode
        //document.body.style.color = "#FFF";
        //document.body.style.backgroundColor = "#171717";
      } else {
        //document.body.style.color = "";
        //document.body.style.backgroundColor = "";
      }
    });
  </script>
  <script>
    var wrap = document.querySelector("#settingsOptions");
    function togglePiP() {
      const video = document.querySelector('video');
       if (document.pictureInPictureElement) {
          document.exitPictureInPicture();
        } else if (document.pictureInPictureEnabled) {
          video.requestPictureInPicture();
        }
      wrap.style.display = "";
    }
    function toggleFulls() {
      const video = document.querySelector('video');
      video.requestFullscreen();
      wrap.style.display = "";
    }/*
    function play() {
      const video = document.querySelector('video');
      video.play();
      wrap.style.display = "";
    }
    function pause() {
      const video = document.querySelector('video');
      video.pause();
      wrap.style.display = "";
    }*/
    function load() {
      const video = document.querySelector('video');
      video.load();
      // wrap.style.display = "";
    }
    function mute() {
      const video = document.querySelector('video');
      if (!video.muted) {
        video.muted = true;
      } else {
        video.muted = false;
      }
      wrap.style.display = "";
    }
  </script>
  <script>
      function openWrap(mod) {
        if (mod === 'settings') {
          var wrap = document.querySelector("#settingsOptions");
        } else {
          var wrap = document.querySelector("#urlInput");
          var wrapURL = document.querySelector("#urlBar");
          setTimeout(function() {
            wrapURL.focus();
          }, 100);
        }
        wrap.style.display = "block";
      }

      function closeWrap(e, mod) {
        if (mod === 'settings') {
          var wrap = document.querySelector("#settingsOptions");
          if (e !== null) {
            if (!e.target.classList.contains("card") && !e.target.classList.contains("img")) {
              wrap.style.display = "";
            }
          } else {
            wrap.style.display = "";
          }
        } else {
          var wrap = document.querySelector("#urlInput");
          var urlBar = document.querySelector("#urlBar");
          if (!e.target.classList.contains("noExit")) {
            wrap.style.display = "";
            urlBar.value = "";
          }
        }
        
      }
  </script>
  <script>
    var settingsBtn = document.querySelector(".card.settings");
    var videoPlaying = false;

    video.onplay = (event) => {
      videoPlaying = true;
      // video.style.border = "0.15rem solid #007000";
    };
    
    document.onclick = function() {
      if (!video.classList.contains("error") && video.src && videoPlaying) {
        // video.style.border = "0.15rem solid #007000";
      }
    };
    /*
    document.addEventListener("visibilitychange", function() {
      if (document.visibilityState === 'hidden') {
         if (!video.classList.contains("error") && video.src) {
            // video.style.border = "0.15rem solid #A10000";
          }
      }
    });*/
  </script>
  <script>

    // REFERENCE: https://web.dev/articles/customize-install

    // Initialize deferredPrompt for use later to show browser install prompt.
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later.
      deferredPrompt = e;
      // Update UI notify the user they can install the PWA
      showInstallPromotion();
      // Optionally, send analytics event that PWA install promo was shown.
      // console.log(`'beforeinstallprompt' event was fired.`);
    });

    function showInstallPromotion() {
      var btn = document.querySelector(".card.install");
      btn.style.opacity = "";
      // btn.style.cursor = "pointer";
      btn.classList.add("pointer");
      btn.addEventListener("click", startInstall);
    }

    function hideInstallPromotion() {
      var btn = document.querySelector(".card.install");
      btn.style.opacity = "0.3";
      // btn.style.cursor = "auto";
      btn.classList.remove("pointer");
      btn.removeEventListener("click", startInstall);
    }

    async function startInstall() {
      // Hide the app provided install promotion
      hideInstallPromotion();
      // Show the install prompt
      deferredPrompt.prompt();
      // Wait for the user to respond to the prompt
      const { outcome } = await deferredPrompt.userChoice;
      // Optionally, send analytics event with outcome of user choice
      // console.log(`User response to the install prompt: ${outcome}`);
      // We've used the prompt and can't use it again, throw it away
      deferredPrompt = null;
    }

    window.addEventListener('appinstalled', () => {
      // Hide the app-provided install promotion
      hideInstallPromotion();
      // Clear the deferredPrompt so it can be garbage collected
      deferredPrompt = null;
      // Optionally, send analytics event to indicate successful install
      // console.log('PWA was installed');

      closeWrap(null, 'settings');
    });

    function getPWADisplayMode() {
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
      if (document.referrer.startsWith('android-app://')) {
        return 'twa';
      } else if (navigator.standalone || isStandalone) {
        return 'standalone';
      }
      return 'browser';
    }

    window.matchMedia('(display-mode: standalone)').addEventListener('change', (evt) => {
      let displayMode = 'browser';
      if (evt.matches) {
        displayMode = 'standalone';
        hideInstallPromotion();
      }
      // Log display mode change to analytics
      // console.log('DISPLAY_MODE_CHANGED', displayMode);
    });
  </script>
  <script>
    
    function checkInitParam() {
      let params = new URLSearchParams(document.location.search);
      const init = params.get("init"); 

      if (init === "file") {
        /*
        setTimeout(function() {
          document.getElementById('fileSelector').click();
        }, 100);*/

      } else if (init === "url") {

        openWrap('webupload');

        /*
        setTimeout(function() {
          var wrapURL = document.querySelector("#urlBar");
          setTimeout(function() {
            wrapURL.focus();
          }, 100);
        }, 100);*/

      }
      
    }

    checkInitParam();

  </script>
</html>
